# Notion Integration Expert Skill

Notion APIã‚’ä½¿ç”¨ã—ãŸæ—¥å ±å‡ºåŠ›ã«ç‰¹åŒ–ã—ãŸã‚¹ã‚­ãƒ«

## ãƒˆãƒªã‚¬ãƒ¼

- Notionãƒšãƒ¼ã‚¸ä½œæˆ/æ›´æ–°
- Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
- ãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆï¼ˆè¦‹å‡ºã—/ãƒªã‚¹ãƒˆ/ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- Notionèªè¨¼è¨­å®š

## å°‚é–€é ˜åŸŸ

### 1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```python
from notion_client import Client

notion = Client(auth=os.environ["NOTION_TOKEN"])
DATABASE_ID = os.environ["NOTION_DATABASE_ID"]
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒª

```python
def find_page_by_date(date: str) -> str | None:
    """åŒæ—¥ãƒšãƒ¼ã‚¸ã‚’æ¤œç´¢"""
    response = notion.databases.query(
        database_id=DATABASE_ID,
        filter={
            "property": "æ—¥ä»˜",
            "date": {"equals": date}
        }
    )
    results = response.get("results", [])
    return results[0]["id"] if results else None
```

### 3. ãƒšãƒ¼ã‚¸ä½œæˆ

```python
def create_report_page(report: dict) -> str:
    """æ—¥å ±ãƒšãƒ¼ã‚¸ã‚’æ–°è¦ä½œæˆ"""
    response = notion.pages.create(
        parent={"database_id": DATABASE_ID},
        properties={
            "åå‰": {
                "title": [{"text": {"content": f"{report['meta']['date']} æ—¥å ±"}}]
            },
            "æ—¥ä»˜": {
                "date": {"start": report["meta"]["date"]}
            },
            "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": {
                "select": {"name": "è‡ªå‹•ç”Ÿæˆ"}
            },
            "ã‚­ãƒ£ãƒ—ãƒãƒ£æ•°": {
                "number": report["meta"]["capture_count"]
            },
            "ä½œæ¥­æ™‚é–“(åˆ†)": {
                "number": report["meta"]["total_duration_min"]
            }
        },
        children=build_report_blocks(report)
    )
    return response["url"]
```

### 4. ãƒšãƒ¼ã‚¸æ›´æ–°

```python
def update_report_page(page_id: str, report: dict) -> str:
    """æ—¢å­˜ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°"""
    # ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°
    notion.pages.update(
        page_id=page_id,
        properties={
            "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": {"select": {"name": "è‡ªå‹•ç”Ÿæˆ"}},
            "ã‚­ãƒ£ãƒ—ãƒãƒ£æ•°": {"number": report["meta"]["capture_count"]},
            "ä½œæ¥­æ™‚é–“(åˆ†)": {"number": report["meta"]["total_duration_min"]}
        }
    )

    # æ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤
    existing = notion.blocks.children.list(page_id)
    for block in existing["results"]:
        notion.blocks.delete(block["id"])

    # æ–°è¦ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ 
    notion.blocks.children.append(page_id, children=build_report_blocks(report))

    return f"https://notion.so/{page_id.replace('-', '')}"
```

### 5. ãƒ–ãƒ­ãƒƒã‚¯ãƒ“ãƒ«ãƒ€ãƒ¼

```python
def build_report_blocks(report: dict) -> list:
    """ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰Notionãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”Ÿæˆ"""
    blocks = []

    # åŸºæœ¬æƒ…å ±
    blocks.append(heading_2("ğŸ“Š åŸºæœ¬æƒ…å ±"))
    blocks.append(paragraph(
        f"è¨˜éŒ²æœŸé–“: {report['meta']['first_capture']} ã€œ {report['meta']['last_capture']}\n"
        f"ã‚­ãƒ£ãƒ—ãƒãƒ£æ•°: {report['meta']['capture_count']}å›\n"
        f"ä½œæ¥­æ™‚é–“: {report['meta']['total_duration_min']}åˆ†"
    ))

    # ãƒ¡ã‚¤ãƒ³ä½œæ¥­
    blocks.append(heading_2("ğŸ¯ æœ¬æ—¥ã®ãƒ¡ã‚¤ãƒ³ä½œæ¥­"))
    for task in report.get("main_tasks", []):
        blocks.append(numbered_list_item(task["title"]))
        if task.get("description"):
            blocks.append(paragraph(task["description"]))

    # çŸ¥è¦‹ãƒ»ãƒ¡ãƒ¢
    if report.get("insights"):
        blocks.append(heading_2("ğŸ’¡ çŸ¥è¦‹ãƒ»ãƒ¡ãƒ¢"))
        for insight in report["insights"]:
            blocks.append(bulleted_list_item(
                f"[{insight['category']}] {insight['content']}"
            ))

    # ã‚¢ãƒ—ãƒªä½¿ç”¨çŠ¶æ³
    blocks.append(heading_2("ğŸ“± ã‚¢ãƒ—ãƒªä½¿ç”¨çŠ¶æ³"))
    blocks.append(build_app_table(report["app_usage"]))

    # ä½œæ¥­ãƒ•ã‚¡ã‚¤ãƒ«
    if report.get("files"):
        blocks.append(heading_2("ğŸ“ ä½œæ¥­ãƒ•ã‚¡ã‚¤ãƒ«"))
        for file in report["files"]:
            blocks.append(bulleted_list_item(file))

    # ãƒ•ãƒƒã‚¿ãƒ¼
    blocks.append(divider())
    blocks.append(paragraph("ğŸ¤– Generated by Daily Report Bot"))

    return blocks
```

### 6. ãƒ–ãƒ­ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼

```python
def heading_2(text: str) -> dict:
    return {
        "type": "heading_2",
        "heading_2": {
            "rich_text": [{"type": "text", "text": {"content": text}}]
        }
    }

def paragraph(text: str) -> dict:
    return {
        "type": "paragraph",
        "paragraph": {
            "rich_text": [{"type": "text", "text": {"content": text}}]
        }
    }

def numbered_list_item(text: str) -> dict:
    return {
        "type": "numbered_list_item",
        "numbered_list_item": {
            "rich_text": [{"type": "text", "text": {"content": text}}]
        }
    }

def bulleted_list_item(text: str) -> dict:
    return {
        "type": "bulleted_list_item",
        "bulleted_list_item": {
            "rich_text": [{"type": "text", "text": {"content": text}}]
        }
    }

def divider() -> dict:
    return {"type": "divider", "divider": {}}
```

### 7. ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ

```python
def build_app_table(app_usage: list) -> dict:
    """ã‚¢ãƒ—ãƒªä½¿ç”¨çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ"""
    RANK_EMOJI = {"high": "ğŸ”´ å¤š", "medium": "ğŸŸ¡ ä¸­", "low": "ğŸŸ¢ å°‘"}

    rows = [
        # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
        table_row(["ã‚¢ãƒ—ãƒª", "æ™‚é–“", "é »åº¦", "ä¸»ãªç”¨é€”"])
    ]

    for app in app_usage:
        rows.append(table_row([
            app["name"],
            f"{app['duration_min']}åˆ†",
            RANK_EMOJI.get(app["rank"], "-"),
            app.get("purpose", "-")
        ]))

    return {
        "type": "table",
        "table": {
            "table_width": 4,
            "has_column_header": True,
            "has_row_header": False,
            "children": rows
        }
    }

def table_row(cells: list) -> dict:
    return {
        "type": "table_row",
        "table_row": {
            "cells": [
                [{"type": "text", "text": {"content": cell}}]
                for cell in cells
            ]
        }
    }
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
from notion_client import APIResponseError

def safe_notion_write(report: dict) -> tuple[bool, str]:
    """å®‰å…¨ãªNotionæ›¸è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰"""
    try:
        page_id = find_page_by_date(report["meta"]["date"])

        if page_id:
            url = update_report_page(page_id, report)
        else:
            url = create_report_page(report)

        return True, url

    except APIResponseError as e:
        if e.status == 401:
            return False, "Notionèªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        elif e.status == 404:
            return False, "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        elif e.status == 429:
            # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ - ãƒªãƒˆãƒ©ã‚¤
            time.sleep(60)
            return safe_notion_write(report)
        else:
            return False, f"Notion APIã‚¨ãƒ©ãƒ¼: {e.message}"

    except Exception as e:
        # ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        save_locally(report)
        return False, f"ã‚¨ãƒ©ãƒ¼: {str(e)}ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿ï¼‰"
```

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [04-notion-flow.md](../../docs/design/04-notion-flow.md)
- [data-schema.md](../../docs/api/data-schema.md)
