# システムアーキテクチャ概要

## 1. システム構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Windows PC                                  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                      常駐ロガー (2分間隔)                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │
│  │  │ Window取得  │  │ Screenshot  │  │    OCR     │               │  │
│  │  │ (Win32 API) │  │ (.NET)      │  │ (WinRT)    │               │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘               │  │
│  │         │                │                │                       │  │
│  │         └────────────────┼────────────────┘                       │  │
│  │                          ▼                                        │  │
│  │                   ┌─────────────┐                                 │  │
│  │                   │  raw.jsonl  │ ← ローカル保存                  │  │
│  │                   └─────────────┘                                 │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    日報生成 (ショートカット)                        │  │
│  │                                                                    │  │
│  │  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐       │  │
│  │  │   集計処理   │ ──▶ │  LLM要約    │ ──▶ │ Notion出力  │       │  │
│  │  │  (Python)   │      │ (Gemini)    │      │ (API)       │       │  │
│  │  └─────────────┘      └─────────────┘      └─────────────┘       │  │
│  │         │                    │                    │               │  │
│  │         ▼                    ▼                    ▼               │  │
│  │  features.json         report.json          Notionページ         │  │
│  │                                                   │               │  │
│  │                                                   ▼               │  │
│  │                                          ┌─────────────┐         │  │
│  │                                          │ Toast通知   │         │  │
│  │                                          └─────────────┘         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌─────────────────────┐
                        │      Notion         │
                        │  (日報データベース)  │
                        └─────────────────────┘
```

## 2. コンポーネント一覧

### 2.1 常駐ロガー

| 項目 | 内容 |
|------|------|
| 実行方式 | タスクスケジューラ（ログオン時起動） |
| 実行間隔 | 2分 |
| 実装言語 | PowerShell または C# |
| 出力 | `%LOCALAPPDATA%/DailyReportBot/logs/YYYY-MM-DD.jsonl` |

**取得データ**:
- タイムスタンプ (ISO 8601)
- アクティブウィンドウタイトル
- プロセス名
- OCRテキスト（キーワード/URL/ファイル名抽出済み）

### 2.2 日報生成エンジン

| 項目 | 内容 |
|------|------|
| トリガー | ショートカットキー (Ctrl+Alt+D) |
| 実装言語 | Python |
| 処理内容 | ログ集計 → LLM要約 → Notion出力 |

**サブコンポーネント**:

| 名称 | 役割 | 入力 | 出力 |
|------|------|------|------|
| Aggregator | ログ集計・セッション化 | raw.jsonl | features.json |
| Summarizer | LLM要約 | features.json | report.json |
| NotionWriter | Notionページ作成/更新 | report.json | Notion URL |
| Notifier | Toast通知 | 処理結果 | Windows Toast |

### 2.3 外部サービス連携

| サービス | 用途 | 認証方式 |
|----------|------|----------|
| Google Gemini API | LLM要約生成 | API Key |
| Notion API | 日報ページ作成 | Integration Token |

## 3. データフロー

### 3.1 常駐ロガーフロー

```
[2分タイマー]
     │
     ▼
┌─────────────────┐
│ GetForeground   │ ← Win32 API
│ Window         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Screenshot      │ ← .NET System.Drawing
│ (全画面)        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ OCR             │ ← WinRT Windows.Media.Ocr
│ (テキスト抽出)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Feature抽出     │ ← 正規表現
│ (keywords/urls) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ JSONL追記       │ → raw.jsonl
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ Screenshot削除  │
└─────────────────┘
```

### 3.2 日報生成フロー

```
[ショートカット押下]
     │
     ▼
┌─────────────────┐
│ 当日ログ読込    │ ← raw.jsonl
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ セッション化    │ ← 連続同一状態を圧縮
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 集計処理        │ ← アプリ別時間/頻出キーワード
└────────┬────────┘
         │
         ▼
features.json
         │
         ▼
┌─────────────────┐
│ LLM要約         │ ← Gemini API
│ (構造化出力)    │
└────────┬────────┘
         │
         ▼
report.json
         │
         ▼
┌─────────────────┐
│ Notion出力      │ ← Notion API
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Toast通知       │ → 成功/失敗
└─────────────────┘
```

## 4. ディレクトリ構成

```
%LOCALAPPDATA%/DailyReportBot/
├── logs/
│   ├── 2025-01-15.jsonl      # 日次生ログ
│   ├── 2025-01-16.jsonl
│   └── ...
├── features/
│   ├── 2025-01-15.json       # 集計済み特徴量
│   └── ...
├── reports/
│   ├── 2025-01-15.json       # LLM生成レポート
│   └── ...
├── config/
│   └── settings.json         # 設定ファイル
└── temp/
    └── (一時スクリーンショット)
```

## 5. 設定項目

### 5.1 ロガー設定

| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| `sampling_interval_sec` | 120 | サンプリング間隔（秒） |
| `ocr_enabled` | true | OCR有効/無効 |
| `excluded_apps` | [] | 除外アプリリスト |

### 5.2 日報生成設定

| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| `exclude_recent_sec` | 120 | 直近N秒を除外 |
| `llm_model` | "gemini-2.5-flash" | 使用LLMモデル |
| `fallback_on_llm_error` | true | LLM失敗時テンプレ出力 |

### 5.3 Notion設定

| 項目 | 説明 |
|------|------|
| `notion_token` | Notion Integration Token |
| `database_id` | 日報データベースID |
| `page_title_format` | "{date} 日報" |

## 6. セキュリティ考慮事項

### 6.1 データ保護

- **OCR全文**: ローカルのみ保存、LLMには送信しない
- **圧縮特徴量のみ**: LLMへは`features.json`の要約データのみ送信
- **認証情報**: 環境変数または暗号化設定ファイルで管理

### 6.2 プライバシー

- スクリーンショットは処理後即削除
- 除外アプリ設定で機密アプリを対象外に
- マスク辞書で個人情報をフィルタリング（Phase 5）

## 7. 非機能要件

### 7.1 可用性

- ロガー停止しても日報生成は既存ログで動作
- LLM失敗時はテンプレート日報でフォールバック
- Notion認証失敗時はローカル保存＋リトライ

### 7.2 パフォーマンス

- ロガー: バックグラウンド実行、CPU使用率 < 1%
- 日報生成: 30秒以内に完了
- メモリ使用量: < 100MB

### 7.3 保守性

- ログローテーション: 30日保持（設定可能）
- 監査ログ: 生成履歴を記録（Phase 5）
