# Phase 3: LLM導入仕様

## 概要

| 項目 | 内容 |
|------|------|
| 目標 | 構造化要約で画像例レベルの日報生成 |
| 前提 | Phase 2完了 |
| 期間 | 1週間 |
| 優先度 | 高 |

## スコープ

### 含まれる機能

- ✅ OpenAI API連携
- ✅ 構造化出力（JSON Schema）
- ✅ 本日のメイン作業（3件）自動生成
- ✅ 知見・メモ抽出
- ✅ フォールバック（LLM失敗時テンプレート）
- ✅ プライバシー保護（OCR全文非送信）

### Phase 2からの変更点

| 項目 | Phase 2 | Phase 3 |
|------|---------|---------|
| メイン作業 | 固定テンプレ | LLM生成 |
| 知見・メモ | なし | LLM抽出 |
| 作業サマリー | なし | LLM生成 |
| LLM利用 | なし | OpenAI API |

## 機能要件

### FR-11: LLM要約

| ID | 要件 |
|----|------|
| FR-11.1 | features.jsonをLLMに送信 |
| FR-11.2 | 本日のメイン作業（3件）を生成 |
| FR-11.3 | 知見・メモをカテゴリ別に抽出 |
| FR-11.4 | 作業サマリー（1文）を生成 |

### FR-12: 構造化出力

| ID | 要件 |
|----|------|
| FR-12.1 | JSON Schema で出力形式を指定 |
| FR-12.2 | strict: true で厳密なスキーマ準拠 |
| FR-12.3 | スキーマ不一致時はフォールバック |

### FR-13: プライバシー保護

| ID | 要件 |
|----|------|
| FR-13.1 | OCR全文はLLMに送信しない |
| FR-13.2 | 送信するのは圧縮済み特徴量のみ |
| FR-13.3 | URL はドメインのみに変換して送信 |

### FR-14: フォールバック

| ID | 要件 |
|----|------|
| FR-14.1 | API接続失敗時はテンプレート日報生成 |
| FR-14.2 | レート制限時は60秒待機後リトライ |
| FR-14.3 | 3回失敗でテンプレートに切替 |
| FR-14.4 | フォールバック時もNotionに出力 |

## プロンプト仕様

### システムプロンプト

```markdown
あなたはPC作業ログから日報を生成するアシスタントです。

## 出力ルール

1. **本日のメイン作業** (3件)
   - 作業時間・重要度を考慮
   - 動詞で終わる（実装した、調査した、修正した）

2. **知見・メモ**
   - カテゴリ: 技術 / プロセス / その他
   - 将来役立つ情報を優先

3. **注意**
   - 推測で補完しない
   - 入力にない内容は書かない
```

### 出力スキーマ

```json
{
  "main_tasks": [
    {"title": "string", "description": "string"}
  ],
  "insights": [
    {"category": "技術|プロセス|その他", "content": "string"}
  ],
  "work_summary": "string"
}
```

## データ仕様

### report.json

```json
{
  "meta": {
    "date": "2025-01-15",
    "llm_model": "gpt-4o-mini",
    "llm_success": true
  },
  "main_tasks": [
    {
      "title": "Flask APIエンドポイントの実装",
      "description": "認証用REST APIを3エンドポイント実装した"
    },
    {
      "title": "ドキュメント調査・レビュー",
      "description": "Flask認証パターンを調査した"
    },
    {
      "title": "コードレビュー対応",
      "description": "チームからのレビューに対応した"
    }
  ],
  "insights": [
    {
      "category": "技術",
      "content": "Flask-JWTのトークン有効期限デフォルト値に注意"
    }
  ],
  "work_summary": "Flask APIの認証機能実装に注力した",
  "app_usage": [...],
  "files": [...]
}
```

## 受け入れ基準

### AC-7: LLM要約

- [ ] メイン作業3件が自然な日本語
- [ ] 知見がカテゴリ分類されている
- [ ] 入力にない情報が含まれていない

### AC-8: フォールバック

- [ ] API失敗時にテンプレート日報生成
- [ ] テンプレート日報もNotionに出力
- [ ] エラー内容がログに記録

### AC-9: コスト

- [ ] 1日あたりLLMコスト $0.01未満

## 実装タスク

| タスク | 見積 |
|--------|------|
| OpenAI SDK導入 | 1h |
| プロンプト実装 | 3h |
| 構造化出力実装 | 2h |
| フォールバック実装 | 2h |
| プライバシー処理 | 2h |
| Notion出力更新 | 2h |
| テスト | 4h |

## コスト見積

| 項目 | 値 |
|------|------|
| 入力トークン | ~800 |
| 出力トークン | ~300 |
| 合計/回 | ~1,100 |
| 月間（30回） | ~33,000トークン |
| 月間コスト | ~$0.01 |
