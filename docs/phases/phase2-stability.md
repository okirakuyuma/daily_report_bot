# Phase 2: 安定運用仕様

## 概要

| 項目 | 内容 |
|------|------|
| 目標 | セッション化・再生成・Toast強化 |
| 前提 | Phase 1完了 |
| 期間 | 1週間 |
| 優先度 | 高 |

## スコープ

### 含まれる機能

- ✅ セッション化（連続同一状態をマージ）
- ✅ プロセス名取得
- ✅ 時間ブロック生成（30分単位）
- ✅ 再生成機能（日付指定で過去日報生成）
- ✅ 直近N秒除外（安定化）
- ✅ Toast強化（アクションボタン）
- ✅ 上書き更新戦略

### Phase 1からの変更点

| 項目 | Phase 1 | Phase 2 |
|------|---------|---------|
| プロセス名 | なし | 取得 |
| セッション化 | なし | あり |
| 時間ブロック | なし | 30分単位 |
| 再生成 | 当日のみ | 過去日指定可 |
| Toast | 基本 | アクション付き |

## 機能要件

### FR-5: セッション化

| ID | 要件 |
|----|------|
| FR-5.1 | 連続する同一(window_title, process_name)をセッションとしてマージ |
| FR-5.2 | セッションに開始時刻・終了時刻・継続時間を含める |
| FR-5.3 | セッション境界はアプリ/ウィンドウ変更時 |

### FR-6: プロセス名取得

| ID | 要件 |
|----|------|
| FR-6.1 | GetWindowThreadProcessIdでプロセスIDを取得 |
| FR-6.2 | Process.GetProcessByIdでプロセス名を取得 |
| FR-6.3 | プロセス名からアプリ表示名にマッピング |

### FR-7: 時間ブロック

| ID | 要件 |
|----|------|
| FR-7.1 | 30分単位で時間ブロックを生成 |
| FR-7.2 | 各ブロックにアプリ別使用率を含める |
| FR-7.3 | 各ブロックに上位キーワードを含める |

### FR-8: 再生成

| ID | 要件 |
|----|------|
| FR-8.1 | CLI引数で日付指定可能 (`--date 2025-01-15`) |
| FR-8.2 | 指定日のログファイルを読み込み |
| FR-8.3 | 既存Notionページを上書き更新 |

### FR-9: 直近除外

| ID | 要件 |
|----|------|
| FR-9.1 | 生成時点から直近N秒（デフォルト120秒）を除外 |
| FR-9.2 | 設定で除外秒数を変更可能 |

### FR-10: Toast強化

| ID | 要件 |
|----|------|
| FR-10.1 | 成功Toast: 「Notionを開く」ボタン |
| FR-10.2 | 失敗Toast: 「ログを開く」ボタン |
| FR-10.3 | Toast表示時間を設定可能 |

## データ仕様

### raw.jsonl（Phase 2版）

```json
{
  "ts": "2025-01-15T09:00:00+09:00",
  "window_title": "main.py - Visual Studio Code",
  "process_name": "Code.exe",
  "keywords": ["Python", "def"],
  "urls": ["docs.python.org"],
  "files": ["main.py"]
}
```

### features.json（新規）

```json
{
  "meta": {
    "date": "2025-01-15",
    "capture_count": 240,
    "total_duration_min": 478
  },
  "sessions": [
    {
      "app": "Visual Studio Code",
      "process": "Code.exe",
      "start": "09:00",
      "end": "10:30",
      "duration_min": 90,
      "keywords": ["Python", "Flask"]
    }
  ],
  "time_blocks": [
    {
      "start": "09:00",
      "end": "09:30",
      "apps": [{"name": "VSCode", "percent": 80}]
    }
  ],
  "app_summary": [...]
}
```

## 受け入れ基準

### AC-4: セッション化

- [ ] 連続同一アプリがマージされる
- [ ] セッション継続時間が正確
- [ ] アプリ切り替えで新セッション

### AC-5: 再生成

- [ ] `--date 2025-01-15`で過去日報生成
- [ ] 既存ページが上書きされる
- [ ] 存在しない日付でエラー

### AC-6: Toast

- [ ] 成功Toastでボタンクリック→Notion開く
- [ ] 失敗Toastでボタンクリック→ログフォルダ開く

## 実装タスク

| タスク | 見積 |
|--------|------|
| プロセス名取得追加 | 2h |
| セッション化ロジック | 4h |
| 時間ブロック生成 | 3h |
| 再生成CLI | 2h |
| 直近除外実装 | 1h |
| Toast強化 | 2h |
| テスト | 3h |
