# 常駐ロガーフロー設計

## 1. 概要

### 1.1 目的

PC作業の状態を定期的にキャプチャし、後続の日報生成のための生データを蓄積する。

### 1.2 実行方式

| 項目 | 内容 |
|------|------|
| 起動方式 | タスクスケジューラ（ログオン時自動起動） |
| 実行間隔 | 2分（120秒） |
| 実行モード | バックグラウンド（ウィンドウ非表示） |
| 実装言語 | PowerShell（推奨）または C# |

## 2. フロー詳細

### 2.1 メインループ

```
┌──────────────────────────────────────────────────────────────┐
│                        START                                  │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 1. タイムスタンプ取得                                         │
│    $ts = (Get-Date).ToString("o")                            │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 2. フォアグラウンドウィンドウ情報取得                          │
│    - ウィンドウハンドル (GetForegroundWindow)                  │
│    - ウィンドウタイトル (GetWindowText)                        │
│    - プロセス名 (GetWindowThreadProcessId → Process)          │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 3. スクリーンショット取得                                     │
│    - 全画面キャプチャ (CopyFromScreen)                        │
│    - 一時ファイルとしてPNG保存                                 │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 4. OCR実行                                                    │
│    - WinRT OcrEngine で画像からテキスト抽出                    │
│    - 失敗時は null として続行                                  │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 5. 特徴量抽出（正規表現）                                      │
│    - キーワード抽出                                            │
│    - URL/ドメイン抽出                                          │
│    - ファイルパス抽出                                          │
│    - 数値抽出（%、金額等）                                     │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 6. JSONLレコード作成・追記                                     │
│    - 日付別ファイルに追記                                      │
│    - UTF-8エンコーディング                                     │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 7. スクリーンショット削除                                      │
│    - 一時ファイルを確実に削除                                  │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│ 8. スリープ (120秒)                                           │
└──────────────────────────────────────────────────────────────┘
                              │
                              └──────────────▶ ループ継続
```

### 2.2 シーケンス図

```
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ Timer   │  │ Win32   │  │ Screen  │  │  OCR    │  │  File   │
│         │  │  API    │  │ Capture │  │ Engine  │  │ System  │
└────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘
     │            │            │            │            │
     │ tick       │            │            │            │
     ├───────────▶│            │            │            │
     │            │            │            │            │
     │            │ GetForegroundWindow()   │            │
     │            ├───────────▶│            │            │
     │            │◀───────────┤            │            │
     │            │ hWnd       │            │            │
     │            │            │            │            │
     │            │ GetWindowText(hWnd)     │            │
     │            ├───────────▶│            │            │
     │            │◀───────────┤            │            │
     │            │ title      │            │            │
     │            │            │            │            │
     │            │            │ CopyFromScreen()        │
     │            │            ├───────────▶│            │
     │            │            │◀───────────┤            │
     │            │            │ bitmap     │            │
     │            │            │            │            │
     │            │            │ Save(temp.png)          │
     │            │            ├────────────────────────▶│
     │            │            │            │            │
     │            │            │            │ RecognizeAsync()
     │            │            │            ├───────────▶│
     │            │            │            │◀───────────┤
     │            │            │            │ ocrText    │
     │            │            │            │            │
     │            │            │            │ ExtractFeatures()
     │            │            │            ├───────────▶│
     │            │            │            │            │
     │            │ AppendJSONL(record)     │            │
     │            ├─────────────────────────────────────▶│
     │            │            │            │            │
     │            │ Delete(temp.png)        │            │
     │            ├─────────────────────────────────────▶│
     │            │            │            │            │
     │ sleep(120s)│            │            │            │
     ├───────────▶│            │            │            │
     │            │            │            │            │
```

## 3. データ仕様

### 3.1 出力ファイル

| 項目 | 値 |
|------|------|
| パス | `%LOCALAPPDATA%/DailyReportBot/logs/YYYY-MM-DD.jsonl` |
| 形式 | JSON Lines (1行1レコード) |
| エンコーディング | UTF-8 (BOM無し) |

### 3.2 レコードスキーマ

```json
{
  "ts": "2025-01-15T14:30:00.000+09:00",
  "window_title": "daily_report_bot - Visual Studio Code",
  "process_name": "Code.exe",
  "keywords": ["Python", "def", "class", "import"],
  "urls": ["https://docs.python.org"],
  "files": ["main.py", "config.json"],
  "numbers": ["100%", "3.14"]
}
```

### 3.3 フィールド定義

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `ts` | string | ✅ | ISO 8601形式タイムスタンプ |
| `window_title` | string \| null | ✅ | ウィンドウタイトル（取得不可時null） |
| `process_name` | string \| null | ❌ | プロセス名（Phase 2以降） |
| `keywords` | string[] | ❌ | 抽出キーワード |
| `urls` | string[] | ❌ | 抽出URL/ドメイン |
| `files` | string[] | ❌ | 抽出ファイルパス |
| `numbers` | string[] | ❌ | 抽出数値 |

## 4. 特徴量抽出ルール

### 4.1 キーワード抽出

```
対象: プログラミング言語キーワード、ツール名、プロジェクト名
例: Python, React, VSCode, Slack, Notion
方式: 辞書マッチング + 頻出単語抽出
```

### 4.2 URL抽出

```
パターン: https?://[^\s<>"{}|\\^`\[\]]+
例: https://github.com/user/repo
```

### 4.3 ファイルパス抽出

```
パターン:
  - Windows: [A-Za-z]:\\[^\s<>"|?*]+
  - Unix-like: /[^\s<>"|?*]+
  - 相対: \w+\.(py|js|ts|json|md|txt|csv|xlsx)
```

### 4.4 数値抽出

```
パターン:
  - パーセント: \d+(\.\d+)?%
  - 金額: ¥[\d,]+|[$€][\d,.]+
  - 一般数値: \d{3,}
```

## 5. エラーハンドリング

### 5.1 エラー種別と対応

| エラー | 対応 | ログレベル |
|--------|------|-----------|
| ウィンドウ取得失敗 | `window_title: null`で続行 | WARN |
| スクリーンショット失敗 | OCRスキップ、ウィンドウ情報のみ記録 | WARN |
| OCR失敗 | キーワード等を空配列で記録 | WARN |
| JSONL書込失敗 | リトライ(3回)、失敗時ログ出力 | ERROR |
| 致命的エラー | プロセス再起動（タスクスケジューラ） | CRITICAL |

### 5.2 リカバリー

```
ロガー停止 → 日報生成は既存ログで動作
ファイルロック → 1秒待機後リトライ
ディスク容量不足 → 古いログ削除（30日以上）
```

## 6. 設定パラメータ

```json
{
  "logger": {
    "sampling_interval_sec": 120,
    "ocr_enabled": true,
    "ocr_language": "ja",
    "excluded_processes": ["LockApp.exe", "ScreenClipping.exe"],
    "excluded_window_titles": ["*password*", "*credential*"],
    "log_retention_days": 30,
    "temp_dir": "%TEMP%/DailyReportBot"
  }
}
```

## 7. 実装ノート

### 7.1 Win32 API呼び出し (PowerShell)

```powershell
Add-Type @"
using System;
using System.Text;
using System.Runtime.InteropServices;
using System.Diagnostics;

public static class Win32 {
    [DllImport("user32.dll")]
    public static extern IntPtr GetForegroundWindow();

    [DllImport("user32.dll", CharSet=CharSet.Auto)]
    public static extern int GetWindowText(IntPtr hWnd, StringBuilder text, int count);

    [DllImport("user32.dll")]
    public static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint processId);
}
"@
```

### 7.2 OCR呼び出し (WinRT)

```powershell
# WinRT OCR は環境によって動作が不安定なため
# 代替案: PsOcr モジュール または C# 実装
```

### 7.3 タスクスケジューラ設定

```
トリガー: ログオン時
操作: powershell.exe
引数: -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File "C:\path\logger.ps1"
設定:
  - 「最上位の特権で実行」オフ
  - 「タスクを停止するまでの時間」なし（無期限）
```

## 8. テスト観点

### 8.1 単体テスト

- [ ] ウィンドウ情報取得が正常動作
- [ ] スクリーンショットが正常保存・削除
- [ ] OCRがテキスト抽出可能
- [ ] 特徴量抽出パターンが期待通り動作
- [ ] JSONLが正しいフォーマットで出力

### 8.2 統合テスト

- [ ] 2分間隔で正常にループ
- [ ] 日付跨ぎでファイルが切り替わる
- [ ] 長時間稼働でメモリリークなし
- [ ] プロセス再起動後も正常動作

### 8.3 異常系テスト

- [ ] 全画面ゲーム中の動作
- [ ] ロック画面中の動作
- [ ] 高DPI環境でのスクリーンショット
- [ ] マルチモニター環境での動作
